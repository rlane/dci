#!/usr/bin/env ruby
require 'rubygems'
require 'xapian'
require 'dci'

DATA_FILENAME = "var/data.analyzed"
INDEX_FILENAME = "var/index"

$db = Xapian::WritableDatabase.new(INDEX_FILENAME, Xapian::DB_CREATE_OR_OVERWRITE)
$term_generator = Xapian::TermGenerator.new()
$term_generator.stemmer = Xapian::Stem.new("english")

def index tth, locations, texts, terms, size, mimetype
	doc = Xapian::Document.new
	doc.add_term DCI::Index.mkterm(:tth, tth)
	terms.each { |type,term| doc.add_term DCI::Index.mkterm(type,term) }
	usernames = locations.map { |x,_| x }.uniq
	usernames.each { |x| doc.add_term DCI::Index.mkterm(:username, x) }
	$term_generator.document = doc
	texts.each { |text| $term_generator.index_text text, 1, DCI::Index::PREFIXES[:text] }
	doc.add_value DCI::Index::SIZE_VALUENO, size.to_s
	#puts doc.terms.map { |t| t.term }.join(' ')
	doc.data = Marshal.dump({:tth => tth, :locations => locations, :size => size, :mimetype => mimetype})
	$db.add_document doc
end

data = DCI::MarshalledDB.new DATA_FILENAME
n = data.size
i = 0
data.each do |tth,v|
	#puts "indexing #{tth}"
	i += 1
	index tth, v[:locations], v[:texts], v[:terms], v[:size], v[:mimetype]
	puts "indexed #{i}/#{n}" if (i % 10000) == 0
end
data.close
